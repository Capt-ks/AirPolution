# .github/workflows/update-air-quality-card.yml

name: Update Air Quality Card Image

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies for node-canvas
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev libpixman-1-dev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install canvas
        run: npm install canvas

      - name: Generate card image
        env:
          PURPLEAIR_API_KEY: ${{ secrets.PURPLEAIR_API_KEY }}
        run: |
          node -e '
          const { createCanvas, loadImage } = require("canvas");
          const fs = require("fs");

          (async () => {
            const apiKey = process.env.PURPLEAIR_API_KEY;
            if (!apiKey) throw new Error("No API key provided");

            const sensorIndex = 130815;
            const response = await fetch(`https://api.purpleair.com/v1/sensors/${sensorIndex}?fields=name,last_seen,pm2.5_atm,temperature,humidity,pressure`, {
              headers: { "X-API-Key": apiKey }
            });

            if (!response.ok) {
              const errText = await response.text();
              throw new Error(`API error ${response.status}: ${errText}`);
            }

            const data = await response.json();
            const s = data.sensor;
            const pm25 = parseFloat(s["pm2.5_atm"]) || 0;
            const temp = s.temperature !== undefined ? s.temperature.toFixed(1) + "°F" : "N/A";
            const hum = s.humidity !== undefined ? s.humidity.toFixed(0) + "%" : "N/A";
            const updateStr = new Date(s.last_seen * 1000).toLocaleString();

            function getAQIInfo(p) {
              if (p <= 12.0) return { level: "Good", desc: "Air quality is satisfactory", color: "#00e400" };
              if (p <= 35.4) return { level: "Moderate", desc: "Acceptable; caution for sensitive", color: "#ffff00" };
              if (p <= 55.4) return { level: "Unhealthy for Sensitive", desc: "Reduce outdoor activity", color: "#ff7e00" };
              if (p <= 150.4) return { level: "Unhealthy", desc: "Everyone reduce activity", color: "#ff0000" };
              if (p <= 250.4) return { level: "Very Unhealthy", desc: "Avoid outdoor activity", color: "#8f3f97" };
              return { level: "Hazardous", desc: "Health emergency", color: "#7e0023" };
            }
            const aqi = getAQIInfo(pm25);

            const canvas = createCanvas(800, 800);
            const ctx = canvas.getContext("2d");

            const bg = await loadImage("https://www.puertorico.com/wp-content/uploads/2023/05/seven-seas-beach-min.jpg");
            ctx.drawImage(bg, 0, 0, 800, 800);

            ctx.fillStyle = "rgba(0,0,0,0.55)";
            ctx.fillRect(0, 0, 800, 800);

            const logo = await loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png");
            ctx.drawImage(logo, 40, 30, 140, 140);

            ctx.textAlign = "center";
            ctx.fillStyle = "white";

            ctx.font = "bold 52px Arial";
            ctx.fillText("Air Quality", 400, 100);
            ctx.font = "48px Arial";
            ctx.fillText("Fajardo, Puerto Rico", 400, 160);

            ctx.font = "bold 140px Arial";
            ctx.fillStyle = aqi.color;
            ctx.fillText(pm25.toFixed(1), 400, 330);

            ctx.font = "50px Arial";
            ctx.fillStyle = "white";
            ctx.fillText("µg/m³ PM2.5", 400, 390);

            ctx.font = "bold 52px Arial";
            ctx.fillStyle = aqi.color;
            ctx.fillText(aqi.level, 400, 470);

            ctx.font = "38px Arial";
            ctx.fillStyle = "white";
            ctx.fillText(aqi.desc, 400, 520);

            ctx.font = "32px Arial";
            ctx.textAlign = "left";
            ctx.fillStyle = "white";
            ctx.fillText(`Temperature: ${temp}`, 60, 600);
            ctx.fillText(`Humidity: ${hum}`, 60, 650);

            ctx.textAlign = "right";
            ctx.fillText(`Updated: ${updateStr}`, 740, 650);

            ctx.textAlign = "center";
            ctx.font = "28px Arial";
            ctx.fillStyle = "#a0e4ff";
            ctx.fillText("Source: Local PurpleAir Sensor | RabirubiaWeather", 400, 740);

            const buffer = canvas.toBuffer("image/png");
            fs.writeFileSync("card.png", buffer);
            console.log("card.png generated successfully");
          })().catch(err => {
            console.error("Generation error:", err);
            process.exit(1);
          });
          '

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add card.png
          git commit -m "Auto-update air quality card image" || echo "No changes to commit"
          git push
