# .github/workflows/update-air-quality-card.yml

name: Update Air Quality Card Image

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing commits

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Default token has write permission

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install sharp
        run: npm install sharp

      - name: Generate card image with sharp
        env:
          PURPLEAIR_API_KEY: ${{ secrets.PURPLEAIR_API_KEY }}
        run: |
          node -e '
          const sharp = require("sharp");
          const fetch = require("node-fetch");
          const fs = require("fs");

          (async () => {
            const apiKey = process.env.PURPLEAIR_API_KEY;
            if (!apiKey) throw new Error("No API key");

            const res = await fetch("https://api.purpleair.com/v1/sensors/130815?fields=name,last_seen,pm2.5_atm,temperature,humidity,pressure", {
              headers: { "X-API-Key": apiKey }
            });
            if (!res.ok) throw new Error("API error: " + await res.text());
            const data = await res.json();
            const s = data.sensor;
            const pm25 = parseFloat(s["pm2.5_atm"]) || 0;
            const temp = s.temperature ? s.temperature.toFixed(1) + "°F" : "N/A";
            const hum = s.humidity ? s.humidity.toFixed(0) + "%" : "N/A";
            const updateStr = new Date(s.last_seen * 1000).toLocaleString();

            function getAQIInfo(p) {
              if (p <= 12.0) return { level: "Good", desc: "Air quality is satisfactory", color: { r: 0, g: 228, b: 0 } };
              if (p <= 35.4) return { level: "Moderate", desc: "Acceptable; caution for sensitive", color: { r: 255, g: 255, b: 0 } };
              if (p <= 55.4) return { level: "Unhealthy for Sensitive", desc: "Reduce outdoor activity", color: { r: 255, g: 126, b: 0 } };
              if (p <= 150.4) return { level: "Unhealthy", desc: "Everyone reduce activity", color: { r: 255, g: 0, b: 0 } };
              if (p <= 250.4) return { level: "Very Unhealthy", desc: "Avoid outdoor activity", color: { r: 143, g: 63, b: 151 } };
              return { level: "Hazardous", desc: "Health emergency", color: { r: 126, g: 0, b: 35 } };
            }
            const aqi = getAQIInfo(pm25);

            // Download background and logo
            const bgRes = await fetch("https://www.puertorico.com/wp-content/uploads/2023/05/seven-seas-beach-min.jpg");
            const bgBuffer = await bgRes.arrayBuffer();
            const logoRes = await fetch("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png");
            const logoBuffer = await logoRes.arrayBuffer();

            const svgText = `
            <svg width="800" height="800">
              <rect width="800" height="800" fill="rgba(0,0,0,0.55)"/>
              <image href="data:image/png;base64,${Buffer.from(logoBuffer).toString("base64")}" x="40" y="30" width="140" height="140"/>
              <text x="400" y="100" font-family="Arial" font-size="52" font-weight="bold" fill="white" text-anchor="middle">Air Quality</text>
              <text x="400" y="160" font-family="Arial" font-size="48" fill="white" text-anchor="middle">Fajardo, Puerto Rico</text>
              <text x="400" y="330" font-family="Arial" font-size="140" font-weight="bold" fill="rgb(${aqi.color.r},${aqi.color.g},${aqi.color.b})" text-anchor="middle">${pm25.toFixed(1)}</text>
              <text x="400" y="390" font-family="Arial" font-size="50" fill="white" text-anchor="middle">µg/m³ PM2.5</text>
              <text x="400" y="470" font-family="Arial" font-size="52" font-weight="bold" fill="rgb(${aqi.color.r},${aqi.color.g},${aqi.color.b})" text-anchor="middle">${aqi.level}</text>
              <text x="400" y="520" font-family="Arial" font-size="38" fill="white" text-anchor="middle">${aqi.desc}</text>
              <text x="60" y="600" font-family="Arial" font-size="32" fill="white">Temperature: ${temp}</text>
              <text x="60" y="650" font-family="Arial" font-size="32" fill="white">Humidity: ${hum}</text>
              <text x="740" y="650" font-family="Arial" font-size="32" fill="white" text-anchor="end">Updated: ${updateStr}</text>
              <text x="400" y="740" font-family="Arial" font-size="28" fill="#a0e4ff" text-anchor="middle">Source: Local PurpleAir Sensor | RabirubiaWeather</text>
            </svg>`;

            await sharp(Buffer.from(bgBuffer))
              .composite([{ input: Buffer.from(svgText), blend: "over" }])
              .png()
              .toFile("card.png");

            console.log("card.png generated successfully with sharp");
          })().catch(err => {
            console.error("Error:", err);
            process.exit(1);
          });
          '

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add card.png
          git commit -m "Auto-update air quality card image" || echo "No changes to commit"
          git push
