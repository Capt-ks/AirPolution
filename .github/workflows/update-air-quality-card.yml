# .github/workflows/update-air-quality-card.yml

name: Update Air Quality Card Image

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Download background and logo
        run: |
          curl -o background.jpg "https://www.puertorico.com/wp-content/uploads/2023/05/seven-seas-beach-min.jpg"
          curl -o logo.png "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png"

      - name: Fetch PurpleAir data and generate card with ImageMagick
        env:
          PURPLEAIR_API_KEY: ${{ secrets.PURPLEAIR_API_KEY }}
        run: |
          # Fetch data
          DATA=$(curl -s -H "X-API-Key: $PURPLEAIR_API_KEY" "https://api.purpleair.com/v1/sensors/130815?fields=pm2.5_atm%2Ctemperature%2Chumidity%2Clast_seen")
          PM25=$(echo $DATA | jq '.sensor.pm2.5_atm // 0' | awk '{printf "%.1f", $1}')
          TEMP=$(echo $DATA | jq '.sensor.temperature // empty' | awk '{printf "%.1f°F", $1}')
          HUM=$(echo $DATA | jq '.sensor.humidity // empty' | awk '{printf "%.0f%%", $1}')
          UPDATE=$(date -d "@$(echo $DATA | jq '.sensor.last_seen')" "+%b %d, %Y %I:%M %p")

          # Determine AQI color and level
          if (( $(awk 'BEGIN {print ('$PM25' <= 12)}') )); then COLOR="#00e400"; LEVEL="Good"; DESC="Air quality is satisfactory"
          elif (( $(awk 'BEGIN {print ('$PM25' <= 35.4)}') )); then COLOR="#ffff00"; LEVEL="Moderate"; DESC="Acceptable; caution for sensitive"
          elif (( $(awk 'BEGIN {print ('$PM25' <= 55.4)}') )); then COLOR="#ff7e00"; LEVEL="Unhealthy for Sensitive"; DESC="Reduce outdoor activity"
          elif (( $(awk 'BEGIN {print ('$PM25' <= 150.4)}') )); then COLOR="#ff0000"; LEVEL="Unhealthy"; DESC="Everyone reduce activity"
          elif (( $(awk 'BEGIN {print ('$PM25' <= 250.4)}') )); then COLOR="#8f3f97"; LEVEL="Very Unhealthy"; DESC="Avoid outdoor activity"
          else COLOR="#7e0023"; LEVEL="Hazardous"; DESC="Health emergency"
          fi

          # Generate card using ImageMagick
          convert background.jpg -resize 800x800^ -gravity center -crop 800x800+0+0 +repage \
            -fill 'rgba(0,0,0,0.55)' -draw "rectangle 0,0 800,800" \
            \( logo.png -resize 140x140 \) -geometry +40+30 -composite \
            -fill white -font DejaVu-Sans-Bold -pointsize 52 -gravity center -annotate +0+0 "Air Quality" \
            -pointsize 48 -annotate +0+60 "Fajardo, Puerto Rico" \
            -fill $COLOR -pointsize 140 -annotate +0-150 "$PM25" \
            -fill white -pointsize 50 -annotate +0-90 "µg/m³ PM2.5" \
            -fill $COLOR -pointsize 52 -annotate +0-20 "$LEVEL" \
            -fill white -pointsize 38 -annotate +0+40 "$DESC" \
            -fill white -pointsize 32 -gravity west -annotate +60+540 "Temperature: $TEMP" \
            -annotate +60+590 "Humidity: $HUM" \
            -gravity east -annotate +740+590 "Updated: $UPDATE" \
            -fill '#a0e4ff' -pointsize 28 -gravity center -annotate +0+300 "Source: Local PurpleAir Sensor | RabirubiaWeather" \
            card.png

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add card.png
          git commit -m "Auto-update air quality card image" || echo "No changes to commit"
          git push
